##copy on write机制（COW）


Copy-on-Write简称COW，不是奶牛，好处就是能保证数据的完整性，掉电的话容易恢复。基本的原理是：当我要修改数据块A的内容的时候，我先把A读出来，写到B块里，如果写的过程掉电了，原来A的内容还在，如果是还写到原来的位置上，那么写入的数据究竟写了多少就不确定了，会不会破坏原来的数据也不好说。很多老的文件系统都不支持COW，比如FAT家族都不支持，但主流的文件系统都多多少少支持一点COW，比如BTRFS，NTFS等。其
实COW对于用户数据来说，并不是特别重要，多数文件系统也不能承诺掉电以后究竟能恢复多少数据（我印象里只有tffs能做到恢复）。COW的好处是对文
件系统元数据的保护，元数据包括文件名、文件大小、属性、路径结构等等，这些数据如果损坏，轻则丢失文件，重则分区完蛋。比如在FAT分区上，如果在大规
模删除、复制文件的时候突然断电，文件夹结构可能就有破坏的风险，而如果支持COW的话，文件系统能很容易回滚数据到前一个状态（虽然也会丢失文件），保
证文件系统自身结构稳定。COW是一定会降低性能的，因为访问的数据量不同，还可能要扫描元数据的bitmap之类的东西，当然设计合理的话用户基本感觉不到（NTFS最早的版本就被用户抱怨说速度太慢，好像就是这个原因）。跟COW相关的还有一个叫Allocate-on-flush或者Delayed Allocation，大概可以称为申请时刷新或者延迟分配，好处就是降低碎片，坏处就是有点费内存。


##write-ahead-log机制（WAL）

